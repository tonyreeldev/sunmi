<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e40af">
    <meta name="description" content="Esc√°ner de c√≥digos de barras para Sunmi V2s">
    <title>Sunmi Barcode Scanner</title>
    
    <style>
        /* Reset y Variables CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --success: #059669;
            --error: #dc2626;
            --warning: #d97706;
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 1rem;
            font-size: 1.125rem;
        }

        .error-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            padding: 2rem;
            z-index: 9999;
            overflow-y: auto;
        }

        .error-screen.show {
            display: block;
        }

        .error-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .error-icon {
            font-size: 4rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .error-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--error);
            text-align: center;
            margin-bottom: 1rem;
        }

        .error-message {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
        }

        .error-solutions {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 2px solid var(--border);
        }

        .error-solutions h3 {
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .error-solutions ul {
            list-style: none;
            padding: 0;
        }

        .error-solutions li {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 0.375rem;
            display: flex;
            align-items: start;
            gap: 0.5rem;
        }

        .error-solutions li::before {
            content: '‚úì';
            color: var(--success);
            font-weight: bold;
            flex-shrink: 0;
        }

        .retry-btn {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .brand-icon {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.2);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .brand h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .brand p {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Main Container */
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* Video Container */
        .video-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 75%;
            background: #1a1a1a;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #888;
        }

        .placeholder svg {
            margin-bottom: 1rem;
        }

        /* Scan Overlay */
        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 400px;
            aspect-ratio: 1;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 1rem;
            pointer-events: none;
            display: none;
        }

        .scan-overlay.active {
            display: block;
        }

        .scan-line {
            position: absolute;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, var(--primary) 50%, transparent 100%);
            box-shadow: 0 0 10px var(--primary);
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }

        .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }

        .corner.tl { top: -2px; left: -2px; border-right: none; border-bottom: none; border-top-left-radius: 1rem; }
        .corner.tr { top: -2px; right: -2px; border-left: none; border-bottom: none; border-top-right-radius: 1rem; }
        .corner.bl { bottom: -2px; left: -2px; border-right: none; border-top: none; border-bottom-left-radius: 1rem; }
        .corner.br { bottom: -2px; right: -2px; border-left: none; border-top: none; border-bottom-right-radius: 1rem; }

        .scan-indicator {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            backdrop-filter: blur(4px);
            display: none;
        }

        .scan-indicator.active {
            display: block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Success Checkmark */
        .success-mark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 80px;
            height: 80px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            box-shadow: 0 0 30px rgba(5,150,105,0.6);
            z-index: 10;
        }

        .success-mark.show {
            animation: successPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes successPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Controls */
        .controls {
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .btn {
            width: 100%;
            padding: 1.25rem;
            font-size: 1.125rem;
            font-weight: 600;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-error {
            background: var(--error);
            color: white;
        }

        .camera-select {
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
            background: white;
        }

        /* Result Display */
        .result {
            margin-top: 1.5rem;
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border-left: 4px solid var(--success);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }

        .result.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .result-code {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 0.5rem;
        }

        .code-value {
            flex: 1;
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }

        .btn-copy {
            padding: 0.75rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-copy:hover {
            background: var(--primary-dark);
        }

        .btn-copy.copied {
            background: var(--success);
        }

        .result-meta {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            font-size: 0.875rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        /* Stats */
        .stats {
            margin-top: 1.5rem;
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }

        .stats.show {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 0.5rem;
        }

        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 0.25rem;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .container {
                padding: 0 0.75rem;
                margin: 1rem auto;
            }
            .brand h1 {
                font-size: 1.25rem;
            }
            .btn {
                padding: 1rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Cargando librer√≠as...</div>
    </div>

    <!-- Error Screen -->
    <div class="error-screen" id="errorScreen">
        <div class="error-content">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h2 class="error-title">Error al Cargar la Aplicaci√≥n</h2>
            <div class="error-message" id="errorMessage"></div>
            <div class="error-solutions">
                <h3>üí° Soluciones Posibles:</h3>
                <ul>
                    <li>Verifica que tengas conexi√≥n a internet (necesaria para la primera carga)</li>
                    <li>Intenta recargar la p√°gina (F5 o deslizar hacia abajo)</li>
                    <li>Limpia el cach√© del navegador</li>
                    <li>Aseg√∫rate de estar usando HTTPS (no HTTP)</li>
                    <li>Prueba con otro navegador (Chrome recomendado)</li>
                    <li>Verifica que no haya bloqueadores de contenido activos</li>
                </ul>
            </div>
            <button class="retry-btn" onclick="location.reload()">üîÑ Reintentar</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="brand">
                    <div class="brand-icon">üì∑</div>
                    <div>
                        <h1>Sunmi Scanner</h1>
                        <p>RP3 Retail Ecuador</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Container -->
        <div class="container">
            <!-- Video Section -->
            <div class="video-wrapper">
                <div class="placeholder" id="placeholder">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                        <circle cx="12" cy="13" r="4"/>
                    </svg>
                    <p>Presiona "Iniciar Escaneo"</p>
                </div>
                
                <video id="video" playsinline muted></video>
                
                <div class="scan-overlay" id="scanOverlay">
                    <div class="scan-line"></div>
                    <div class="corner tl"></div>
                    <div class="corner tr"></div>
                    <div class="corner bl"></div>
                    <div class="corner br"></div>
                </div>
                
                <div class="scan-indicator" id="scanIndicator">
                    üì∏ Escaneando...
                </div>
                
                <div class="success-mark" id="successMark">‚úì</div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button class="btn btn-primary" id="startBtn">
                    ‚ñ∂Ô∏è Iniciar Escaneo
                </button>
                <button class="btn btn-error hidden" id="stopBtn">
                    ‚èπÔ∏è Detener Escaneo
                </button>
                <select class="camera-select hidden" id="cameraSelect"></select>
            </div>

            <!-- Result Display -->
            <div class="result" id="result">
                <div class="result-header">
                    <h3>C√≥digo Escaneado</h3>
                    <button class="btn-copy" onclick="clearResult()">‚úï</button>
                </div>
                <div class="result-code">
                    <div>
                        <small style="color: #888; font-size: 0.75rem;">C√ìDIGO</small>
                        <div class="code-value" id="codeValue">-</div>
                    </div>
                    <button class="btn-copy" id="copyBtn" onclick="copyCode()">üìã</button>
                </div>
                <div class="result-meta">
                    <span id="formatDisplay">-</span>
                    <span id="timeDisplay">-</span>
                    <span id="durationDisplay">-</span>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats" id="stats">
                <h4>üìä Estad√≠sticas de Escaneo</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value" id="totalScans">0</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="successRate">100%</span>
                        <span class="stat-label">√âxito</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="avgTime">0ms</span>
                        <span class="stat-label">Promedio</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ZXing Library desde CDN con verificaci√≥n -->
    <script>
        // Funci√≥n para cargar script con verificaci√≥n
        function loadScript(src, callback) {
            const script = document.createElement('script');
            script.src = src;
            script.onload = callback;
            script.onerror = () => {
                showError(`No se pudo cargar la librer√≠a desde: ${src}\n\nVerifica tu conexi√≥n a internet.`);
            };
            document.head.appendChild(script);
        }

        // Mostrar error
        function showError(message) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorScreen').classList.add('show');
            document.getElementById('errorMessage').textContent = message;
        }

        // Cargar ZXing
        loadScript('https://unpkg.com/@zxing/library@latest/umd/index.min.js', () => {
            // Verificar que ZXing est√© disponible
            if (typeof ZXing === 'undefined') {
                showError('La librer√≠a ZXing no se carg√≥ correctamente.\n\nIntenta recargar la p√°gina o verifica tu conexi√≥n a internet.');
                return;
            }

            console.log('‚úÖ ZXing cargado correctamente');
            
            // Ocultar loading y mostrar app
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Inicializar la aplicaci√≥n
            initApp();
        });

        // Variables globales
        let codeReader = null;
        let selectedDeviceId = null;
        let isScanning = false;
        let stats = {
            total: 0,
            times: []
        };
        let scanStartTime = null;

        // Elementos del DOM
        let video, placeholder, scanOverlay, scanIndicator, successMark;
        let startBtn, stopBtn, cameraSelect, result, statsDiv;

        function initApp() {
            // Obtener referencias del DOM
            video = document.getElementById('video');
            placeholder = document.getElementById('placeholder');
            scanOverlay = document.getElementById('scanOverlay');
            scanIndicator = document.getElementById('scanIndicator');
            successMark = document.getElementById('successMark');
            startBtn = document.getElementById('startBtn');
            stopBtn = document.getElementById('stopBtn');
            cameraSelect = document.getElementById('cameraSelect');
            result = document.getElementById('result');
            statsDiv = document.getElementById('stats');

            // Inicializar esc√°ner
            initScanner();

            // Event listeners
            startBtn.addEventListener('click', startScanning);
            stopBtn.addEventListener('click', stopScanning);
            cameraSelect.addEventListener('change', (e) => {
                selectedDeviceId = e.target.value;
                if (isScanning) {
                    stopScanning();
                    setTimeout(() => startScanning(), 100);
                }
            });
        }

        async function initScanner() {
            try {
                // Crear instancia del lector
                codeReader = new ZXing.BrowserMultiFormatReader();
                
                // Obtener dispositivos de video
                const videoInputDevices = await codeReader.listVideoInputDevices();
                
                if (videoInputDevices.length === 0) {
                    showError('No se encontraron c√°maras en el dispositivo.\n\nVerifica que el dispositivo tenga c√°mara y que los permisos est√©n habilitados.');
                    return;
                }

                // Poblar selector de c√°maras
                if (videoInputDevices.length > 1) {
                    cameraSelect.classList.remove('hidden');
                    videoInputDevices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.text = device.label || `C√°mara ${index + 1}`;
                        cameraSelect.appendChild(option);
                    });
                }

                // Seleccionar c√°mara trasera por defecto
                const backCamera = videoInputDevices.find(device => 
                    device.label.toLowerCase().includes('back') || 
                    device.label.toLowerCase().includes('rear') ||
                    device.label.toLowerCase().includes('trasera')
                );
                
                selectedDeviceId = backCamera ? backCamera.deviceId : videoInputDevices[0].deviceId;
                
                if (cameraSelect.children.length > 0) {
                    cameraSelect.value = selectedDeviceId;
                }

                console.log('‚úÖ Esc√°ner inicializado correctamente');
                console.log(`üì∑ C√°maras disponibles: ${videoInputDevices.length}`);
                
            } catch (err) {
                console.error('Error al inicializar:', err);
                showError(`Error al acceder a las c√°maras:\n\n${err.message}\n\nVerifica los permisos de c√°mara en tu navegador.`);
            }
        }

        async function startScanning() {
            try {
                placeholder.classList.add('hidden');
                scanOverlay.classList.add('active');
                scanIndicator.classList.add('active');
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                
                isScanning = true;
                scanStartTime = Date.now();

                await codeReader.decodeFromVideoDevice(
                    selectedDeviceId,
                    video,
                    (result, err) => {
                        if (result) {
                            handleScanSuccess(result);
                        }
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            console.error('Error de escaneo:', err);
                        }
                    }
                );

            } catch (err) {
                console.error('Error al iniciar escaneo:', err);
                alert('Error al iniciar el esc√°ner. Verifica los permisos de c√°mara.');
                stopScanning();
            }
        }

        function stopScanning() {
            if (codeReader) {
                codeReader.reset();
            }
            isScanning = false;
            scanOverlay.classList.remove('active');
            scanIndicator.classList.remove('active');
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            placeholder.classList.remove('hidden');
        }

        function handleScanSuccess(scanResult) {
            const scanTime = Date.now() - scanStartTime;
            
            // Actualizar estad√≠sticas
            stats.total++;
            stats.times.push(scanTime);
            if (stats.times.length > 10) {
                stats.times.shift();
            }
            
            const avgTime = Math.round(
                stats.times.reduce((a, b) => a + b, 0) / stats.times.length
            );

            // Mostrar resultado
            document.getElementById('codeValue').textContent = scanResult.getText();
            document.getElementById('formatDisplay').textContent = `üìä ${getBarcodeFormatName(scanResult.getBarcodeFormat())}`;
            document.getElementById('timeDisplay').textContent = `üïí ${new Date().toLocaleTimeString('es-EC')}`;
            document.getElementById('durationDisplay').textContent = `‚ö° ${scanTime}ms`;
            
            result.classList.add('show');
            
            // Actualizar estad√≠sticas
            document.getElementById('totalScans').textContent = stats.total;
            document.getElementById('avgTime').textContent = `${avgTime}ms`;
            statsDiv.classList.add('show');

            // Mostrar checkmark
            successMark.classList.add('show');
            setTimeout(() => {
                successMark.classList.remove('show');
            }, 1000);

            // Reproducir beep
            playBeep();

            // Reiniciar timer
            scanStartTime = Date.now();
        }

        function playBeep() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'square';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (err) {
                console.error('Error al reproducir beep:', err);
            }
        }

        function getBarcodeFormatName(format) {
            const formats = {
                0: 'EAN-13', 1: 'EAN-8', 2: 'UPC-A', 3: 'UPC-E',
                4: 'Code 128', 5: 'Code 39', 6: 'Code 93', 7: 'Codabar',
                8: 'ITF', 9: 'QR Code', 10: 'Data Matrix', 11: 'PDF417', 12: 'Aztec'
            };
            return formats[format] || `Formato ${format}`;
        }

        async function copyCode() {
            const code = document.getElementById('codeValue').textContent;
            try {
                await navigator.clipboard.writeText(code);
                const btn = document.getElementById('copyBtn');
                btn.textContent = '‚úì';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'üìã';
                    btn.classList.remove('copied');
                }, 2000);
            } catch (err) {
                alert('Error al copiar: ' + err);
            }
        }

        function clearResult() {
            result.classList.remove('show');
        }
    </script>
</body>
</html>
